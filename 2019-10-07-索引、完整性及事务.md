---
title: 索引、完整性及事务
date: 2019-10-07 09:44:14
tags: 数据库
mathjax: true
---

索引：索引的概念、索引类型、以及创建和删除索引，索引的实现原理。

事务：事务及ACID原则，多用户使用带来的问题，用户自定义事务。

<!--more-->

# 索引

索引使数据库程序无须对整个表进行扫描，就可以在其中找到所需数据。

数据库中的索引是某个表中一列或者若干列值的集合和相应的指向表中物理标识这些值的数据页的逻辑

指针清单。

如何定位数据？

- 表扫描
  - 从磁盘中依次读取所有的数据块，一行一行的进行数据匹配
  - 时间复杂度O(n)，如果100 000行数据占用了200个块，尽量只查询一行数据也需要读出所有200个块的数据。
  - 需要大量的磁盘IO操作，极大的影响了数据定位的性能

如何提高定位数据速度？

- 减少磁盘IO
  - 减少数据占用的磁盘空间。压缩算法、优化数据存储结构
  - 减少访问数据的总量。减少无效数据的访问。

## 索引的产生

多数情况下，定位并不需要匹配整行数据。而是只匹配某一个或几列的值。这些用来确定一条数据的列，统称为键key。

我们将键的值拿过来存放到独立的块中，并且为每一个键值添加一个指向原来的数据块的指针。

当进行定位操作时，不再进行表扫描，而是进行索引扫描。

## 索引的存储

一条索引记录中包含的基本信息包括：键值(即你定义索引时指定的所有字段的值)+逻辑指针(指向数据页或者另一索引页)。

![](https://raw.githubusercontent.com/zxpgo/images/master/img/20191007091215.png)

如果索引表比较大，就需要建立多级索引。

### 索引的分类

- 索引类型

  - 聚集索引
  - 非聚集索引
  - 唯一索引
  - 组合索引

- 索引类型

  - 顺序文件上的索引

  - B+树索引

  - 散列索引

  - 位图索引

#### 聚集索引

对表的物理数据页中的数据按列进行排序，然后再重新存储到磁盘上，即聚集索引与数据是混为一体的。聚集索引和数据库中记录的物理顺序与索引顺序相同。

一个表中只能有一个聚集索引。
 ![](https://raw.githubusercontent.com/zxpgo/images/master/img/20191007091814.png)

  具体索引可应用于下面几种情况：

- 包含大量非重复值的列
- 使用下列运算符返回一个范围值的查询：BETWEEN、>、>=、<和<=
- 被连续访问的列
- 返回大型结果集的查询
- 经常被使用联接或Group By子句查询访问的列

    #### 非聚集索引

非聚集索引和聚集索引一样有B-树结构，但是有差别：

- 数据列不按非聚集索引键的顺序排序和存储
- 非聚集索引中，数据表中记录的物理顺序与索引顺序可以不相同
- 一个表中可以有多个非聚集索引
- 数据与索引存储在不同的位置

![](https://raw.githubusercontent.com/zxpgo/images/master/img/20191007092356.png)

#### 唯一索引

唯一索引表示表中任何两个记录索引值都不相同，与表的主键类似。它可以确保索引列不包含重复的值。在多列唯一索引的情况下，该索引可以确保索引列中每个值组合都是唯一的。

#### 组合索引

组合索引是将两个或多个字段组合起来索引，而单独的字段允许不是唯一的值。

## 索引的创建

创建索引的两种方式：

- 直接创建索引：使用CREATE INDEX 和 企业管理器
- 间接创建索引：定义主键约束或者唯一键约束，可以间接创建索引

在创建索引时，需要指定索引的特征。这些特征包括下面几项：

- 聚集还是非聚集

- 唯一还是不唯一

- 单列还是多列

- 索引中的列顺序为升序还是降序

  ```mysql
  #创建索引
  CREATE INDEX kc_name_ind ON KCB(课程号); 
  #创建唯一聚集索引
  CREATE UNIQUE CLUSTERED INDEX  kc_id_ind ON KCB(课程号);
  #创建复合索引
  CREATE INDEX CJB_ind ON CJB(学号,课程号) WITH(DROP_EXISTING = ON);
  ```

删除索引：

```mysql 
DROP INDEX 'table.index | view.index' [,...n]
```

## 索引优缺点

索引虽然能够加快数据库的插叙，但需要占用一定的存储空间。

另一方面，当基本表更新时，索引要进行相应的维护，这也会增加数据库的负担。比如一个增长型的系统中，用户量不断增加，需要加入新的用户信息到基本表中，每增加1条用户记录，就需要更新索引表，会导致写入数据时的性能下降，影响用户体验。

索引需要根据具体的应用的需要有选择的创建。

## 索引的数据结构

一条索引记录中包含的基本信息包括：键值+逻辑指针。

常见的数据库系统，其索引使用的数据结构多是：B-Tree和B+Tree。例如：Mysql、DB2使用的B+Tree；Oracle、SQLServer以及Sysbase使用的是B-Tree。

### B-Tree

B-Tree是一种平衡的多路查找树。

![](https://raw.githubusercontent.com/zxpgo/images/master/img/20191007095649.png)

上图是一个4阶B-Tree。

一个m阶的B-Tree满足：

- 每个节点最多有m个孩子；
- 除根节点和叶节点外，其他每个节点至少有m/2个孩子；
- 根节点至少有带个孩子（除非该树仅包含一个节点）；
- 所有叶节点在同一层，叶节点不包含任何关键字信息；
- 有k个关键字的非叶子节点恰好包含k+1个孩子；

![](https://raw.githubusercontent.com/zxpgo/images/master/img/20191007100635.png)

#### B-树的查找过程

- 从根节点出发，沿指针搜索节点和在节点内进行顺序（或半折）查找两个过程查找进行。
- 若查找成功，则返回指向被查关键字所在节点的值和关键字在节点中的位置；
- 如果查找不成功，则返回插入位置。

### B+Tree

B+Tree是B-Tree的一个变型。

- 有n课子树的想见面中包含n个关键字；
- 所有叶子节点中包含了全部关键字的信息，及指向包含这些关键字记录的指针，并且所有叶子节点彼此相连构成一个有序链表，其头指针指向内含最小关键字的节点；
- 每个非叶节点中的关键字$K_i$即为其相应指针$A_i$所指子树中关键字的最大值。

![](https://raw.githubusercontent.com/zxpgo/images/master/img/20191007102304.png)

#### B+Tree的查找过程

在B+树上，既可以进行缩小范围的查找，也可以进行顺序查找；

在进行缩小范围的查找时，不管成功与否，都必须查找到叶子节点才能结束；

若在节点内查找时，给定值$<=K_i$，则应继续在$A_i$所指子树中进行查找。

# 事务

- 事务引入：
  - 多用户同时操作数据库
  - 系统在执行用户的请求时出现故障
- 例如：账户张三转账给账户李四1000元

### 事务定义

- 事务是作为单个逻辑工作单元执行的一系列操作

- 这些操作作为一个整体一起向系统提交，要么都执行、要么都不执行

- 事务是一个不可分割的工作逻辑单元

转账过程是一个事务。从而确保转账前后两个账户的总余额不变。

### 事务的特性

事务必须具备以下四个属性，简称ACID属性：

- 原子性(Atomicity): 事务是一个完整的操作。事务的各步操作不可分的，要么都执行，要么都不执行。
- 一致性(Consistency): 当事务完成时，数据必须处于一致状态。
- 隔离性(Isolation):  对数据进行修改的所有并发事务是彼此隔离的，这表明事务必须是独立的，它不应以任何方式依赖于或影响其他事务。
- 永久性(Durability):  事务完成后，它对数据库的修改被永久保持，事务日志能够保持事务的永久性

### 事务的创建

使用下面语句来管理事务：

- 开始事务： BEGIN TRANSACTION
- 提交事务： COMMIT TRANSACTION
- 回滚(撤销)事务： ROLLBACK TRANSACTION

一旦事务提交或回滚，则事务结束。

判断某条语句执行是否出错：

- 使用

### 事务的分类

- 显示事务： 用BEGIN TRANSACTION明确指定事务的开始，这是最常用的事务。
- 隐形事务：通过设置SET IMPLICIT_TRANSACTIONS ON语句，将隐形事务模式设置为打开，下一个语句自动启动一个新事务。当该事务完成时，再下一个T-SQL语句又将启动一个新事务。
- 自动提交事务：这个SQL Server的默认模式，它将每个单独的T-SQL语句视为一个事务，如果成功执行，则自动提交；如果错误，则自动回滚。



